"""
Command line interface for working with agent services
"""
import socket

import typer
import uvicorn
from rich.align import Align
from rich.columns import Columns
from rich.table import Column, Table
from rich.text import Text

from prefect.cli._types import PrefectTyper, SettingsOption
from prefect.cli.root import app
from prefect.settings import PREFECT_AGENT_PREFETCH_SECONDS, PREFECT_API_URL
from prefect.workers.agent_worker import AgentWorker

worker_app = PrefectTyper(
    name="worker", help="Commands for starting and interacting with worker processes."
)
app.add_typer(worker_app)


ascii_name = r"""
  ____            __           _    __        __         _             
 |  _ \ _ __ ___ / _| ___  ___| |_  \ \      / /__  _ __| | _____ _ __ 
 | |_) | '__/ _ \ |_ / _ \/ __| __|  \ \ /\ / / _ \| '__| |/ / _ \ '__|
 |  __/| | |  __/  _|  __/ (__| |_    \ V  V / (_) | |  |   <  __/ |   
 |_|   |_|  \___|_|  \___|\___|\__|    \_/\_/ \___/|_|  |_|\_\___|_|   
"""

ansi_logo = """[38;2;0;0;1m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;5;31;37m [0m[38;2;13;83;99m:[0m[38;2;22;142;170m=[0m[38;2;30;192;234m+[0m[38;2;29;193;239m+[0m[38;2;20;138;176m=[0m[38;2;11;79;105m:[0m[38;2;4;31;42m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;2m [0m[38;2;0;2;4m [0m
[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;2;18;21m [0m[38;2;9;60;71m.[0m[38;2;18;116;137m-[0m[38;2;26;167;199m+[0m[38;2;31;201;244m*[0m[38;2;32;207;255m*[0m[38;2;31;203;255m*[0m[38;2;30;197;255m*[0m[38;2;28;193;255m+[0m[38;2;27;189;255m+[0m[38;2;26;184;255m+[0m[38;2;24;173;247m+[0m[38;2;18;138;204m=[0m[38;2;12;92;142m:[0m[38;2;6;48;77m.[0m[38;2;1;15;25m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m
[38;2;5;36;43m.[0m[38;2;22;141;168m=[0m[38;2;32;207;249m*[0m[38;2;33;210;255m*[0m[38;2;32;206;255m*[0m[38;2;31;202;255m*[0m[38;2;29;197;255m*[0m[38;2;27;187;249m+[0m[38;2;26;183;250m+[0m[38;2;25;181;254m+[0m[38;2;24;177;254m+[0m[38;2;22;171;253m+[0m[38;2;21;166;253m+[0m[38;2;21;164;255m+[0m[38;2;20;160;255m+[0m[38;2;19;156;255m=[0m[38;2;18;151;255m=[0m[38;2;15;137;242m=[0m[38;2;11;105;193m-[0m[38;2;6;63;122m:[0m
[38;2;0;5;6m [0m[38;2;4;25;30m [0m[38;2;8;57;71m.[0m[38;2;15;100;129m-[0m[38;2;21;144;192m=[0m[38;2;25;175;241m+[0m[38;2;25;181;255m+[0m[38;2;24;176;255m+[0m[38;2;23;172;255m+[0m[38;2;22;168;255m+[0m[38;2;21;163;254m+[0m[38;2;20;158;253m+[0m[38;2;18;154;254m=[0m[38;2;16;148;254m=[0m[38;2;15;143;253m=[0m[38;2;14;137;251m=[0m[38;2;13;133;252m=[0m[38;2;13;131;255m=[0m[38;2;11;127;255m=[0m[38;2;9;122;253m=[0m
[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;3;22;32m [0m[38;2;7;57;85m.[0m[38;2;11;93;144m:[0m[38;2;14;120;195m-[0m[38;2;16;142;237m=[0m[38;2;17;153;254m=[0m[38;2;17;150;255m=[0m[38;2;15;143;255m=[0m[38;2;14;136;255m=[0m[38;2;12;130;255m=[0m[38;2;11;125;254m=[0m[38;2;10;121;255m=[0m[38;2;8;116;253m-[0m[38;2;6;109;252m-[0m[38;2;5;97;233m-[0m
[38;2;0;2;3m [0m[38;2;0;4;5m [0m[38;2;0;4;5m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;2;14;19m [0m[38;2;8;62;94m.[0m[38;2;14;120;196m-[0m[38;2;6;91;199m-[0m[38;2;7;98;207m-[0m[38;2;10;114;232m-[0m[38;2;10;119;248m-[0m[38;2;9;118;255m-[0m[38;2;8;113;255m-[0m[38;2;6;108;255m-[0m[38;2;4;101;254m-[0m[38;2;4;97;255m-[0m[38;2;2;86;236m-[0m
[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;2;18;24m [0m[38;2;8;59;78m.[0m[38;2;15;105;144m-[0m[38;2;20;146;208m=[0m[38;2;22;170;252m+[0m[38;2;22;167;255m+[0m[38;2;19;154;252m=[0m[38;2;1;80;238m:[0m[38;2;0;68;225m:[0m[38;2;0;70;214m:[0m[38;2;2;75;212m:[0m[38;2;3;82;220m:[0m[38;2;2;87;231m-[0m[38;2;2;88;243m-[0m[38;2;0;85;247m-[0m[38;2;0;83;253m-[0m[38;2;0;77;240m:[0m
[38;2;7;49;59m.[0m[38;2;16;104;125m-[0m[38;2;23;153;190m=[0m[38;2;28;186;240m+[0m[38;2;28;191;255m+[0m[38;2;26;183;255m+[0m[38;2;24;175;255m+[0m[38;2;22;167;255m+[0m[38;2;19;159;252m+[0m[38;2;16;145;246m=[0m[38;2;2;83;236m:[0m[38;2;0;84;255m-[0m[38;2;0;83;253m-[0m[38;2;0;81;252m:[0m[38;2;0;78;248m:[0m[38;2;0;78;244m:[0m[38;2;0;78;243m:[0m[38;2;0;79;247m:[0m[38;2;0;81;253m:[0m[38;2;0;71;223m:[0m
[38;2;31;197;235m+[0m[38;2;32;209;255m*[0m[38;2;30;201;255m*[0m[38;2;28;193;255m+[0m[38;2;25;183;253m+[0m[38;2;24;174;251m+[0m[38;2;21;168;253m+[0m[38;2;20;161;254m+[0m[38;2;19;156;255m=[0m[38;2;16;142;249m=[0m[38;2;1;73;210m:[0m[38;2;0;80;253m:[0m[38;2;0;82;253m-[0m[38;2;0;82;254m-[0m[38;2;0;83;255m-[0m[38;2;0;81;251m:[0m[38;2;0;67;207m:[0m[38;2;0;46;143m.[0m[38;2;0;24;75m [0m[38;2;0;7;22m [0m
[38;2;29;187;226m+[0m[38;2;30;199;251m*[0m[38;2;28;191;251m+[0m[38;2;26;187;254m+[0m[38;2;25;180;255m+[0m[38;2;23;172;255m+[0m[38;2;21;165;255m+[0m[38;2;19;157;255m=[0m[38;2;17;151;255m=[0m[38;2;14;138;252m=[0m[38;2;1;69;199m:[0m[38;2;0;77;244m:[0m[38;2;0;73;226m:[0m[38;2;0;54;168m:[0m[38;2;0;32;100m.[0m[38;2;0;12;38m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m
[38;2;28;182;227m+[0m[38;2;30;198;255m*[0m[38;2;27;189;254m+[0m[38;2;26;182;255m+[0m[38;2;24;175;255m+[0m[38;2;22;167;255m+[0m[38;2;20;159;255m+[0m[38;2;18;152;255m=[0m[38;2;15;144;254m=[0m[38;2;12;131;249m=[0m[38;2;1;41;112m.[0m[38;2;0;16;54m [0m[38;2;0;4;11m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;1;4m [0m[38;2;0;0;3m [0m[38;2;0;0;1m [0m
[38;2;26;178;227m+[0m[38;2;28;193;255m+[0m[38;2;25;184;254m+[0m[38;2;24;177;255m+[0m[38;2;22;170;255m+[0m[38;2;21;162;255m+[0m[38;2;18;154;255m=[0m[38;2;16;146;254m=[0m[38;2;15;139;255m=[0m[38;2;12;124;243m=[0m[38;2;1;8;10m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;3m [0m[38;2;0;1;4m [0m[38;2;0;0;2m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m
[38;2;25;173;227m+[0m[38;2;27;188;255m+[0m[38;2;24;179;254m+[0m[38;2;23;172;255m+[0m[38;2;21;164;255m+[0m[38;2;19;157;255m=[0m[38;2;17;149;255m=[0m[38;2;14;139;253m=[0m[38;2;12;132;253m=[0m[38;2;10;119;241m-[0m[38;2;0;12;28m [0m[38;2;0;0;2m [0m[38;2;0;0;2m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m
[38;2;24;168;227m+[0m[38;2;26;182;255m+[0m[38;2;23;173;254m+[0m[38;2;22;167;255m+[0m[38;2;19;157;253m=[0m[38;2;17;149;252m=[0m[38;2;15;141;251m=[0m[38;2;13;135;254m=[0m[38;2;12;128;255m=[0m[38;2;10;120;255m=[0m[38;2;0;12;28m [0m[38;2;0;0;0m [0m[38;2;0;0;1m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m
[38;2;23;163;226m+[0m[38;2;23;175;253m+[0m[38;2;21;166;251m+[0m[38;2;20;162;255m+[0m[38;2;18;153;255m=[0m[38;2;16;146;255m=[0m[38;2;14;138;255m=[0m[38;2;12;131;255m=[0m[38;2;9;104;216m-[0m[38;2;5;69;153m:[0m[38;2;0;5;13m [0m[38;2;0;0;1m [0m[38;2;0;0;1m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m
[38;2;22;160;230m=[0m[38;2;23;171;255m+[0m[38;2;21;163;255m+[0m[38;2;18;154;253m=[0m[38;2;14;127;218m=[0m[38;2;9;90;163m:[0m[38;2;5;52;100m.[0m[38;2;2;21;43m [0m[38;2;0;1;3m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m
[38;2;19;142;209m=[0m[38;2;16;124;190m-[0m[38;2;9;74;118m:[0m[38;2;3;33;55m.[0m[38;2;0;4;8m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;1;4m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m[38;2;0;0;0m [0m

"""


@worker_app.command()
async def start(
    worker_type: str = typer.Option(
        "AGENT", "--type", "-t", help="The type of worker to start"
    ),
    worker_pool_name: str = typer.Option(
        None, "--pool", "-p", help="The worker pool this worker should join."
    ),
    name: str = typer.Option(
        None,
        "--name",
        "-n",
        help="A name for this specific worker process. Randomly generated if not provided.",
    ),
    prefetch_seconds: int = SettingsOption(PREFECT_AGENT_PREFETCH_SECONDS),
    api: str = SettingsOption(PREFECT_API_URL),
    host: str = typer.Option(
        "127.0.0.1", "--host", "-h", help="The worker's server host"
    ),
    port: int = typer.Option(
        None,
        "--port",
        "-p",
        help="The worker's server port. If not provided, a random port will be chosen.",
    ),
):
    """
    Start a worker process
    """

    if worker_type == "AGENT":
        worker_cls = AgentWorker
    else:
        raise ValueError("Unrecognized worker type")

    worker = worker_cls(
        worker_pool_name=worker_pool_name,
        name=name,
        prefetch_seconds=prefetch_seconds,
    )

    # find a random unused port
    if port is None:
        sock = socket.socket()
        sock.bind(("", 0))
        port = sock.getsockname()[1]

    app.console.print(
        Columns(
            [
                Text.from_ansi(ansi_logo),
                Align(Text(ascii_name, style="blue"), vertical="middle"),
            ]
        )
    )

    details = Table(
        Column("Title", style="italic"),
        Column("Detail", style="bold"),
        show_header=False,
        box=None,
    )
    details.add_row("Worker pool:", worker.worker_pool_name)
    details.add_row("Worker name:", worker.name)
    details.add_row("Worker type:", worker.type)
    details.add_row("Worker address:", f"http://{host}:{port}")
    details.add_row("Orion API:", api if api else "<ephemeral>")

    app.console.print(details)
    app.console.print()

    # await worker.start()
    config = uvicorn.Config(worker.create_server(), host=host, port=port)
    server = uvicorn.Server(config)

    await server.serve()

    app.console.print(f"{worker.name} stopped!")
